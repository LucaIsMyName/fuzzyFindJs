<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FuzzyFindJS - Text Search Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../dist/umd/fuzzyfindjs.min.js"></script>
  <style>
    /* Match type highlight colors */
    .highlight-exact {
      background-color: #ef4444;
      color: white;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .highlight-fuzzy {
      background-color: #60a5fa;
      color: white;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .highlight-phonetic {
      background-color: #a78bfa;
      color: white;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .highlight-synonym {
      background-color: #facc15;
      color: black;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .highlight-prefix {
      background-color: #34d399;
      color: white;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .highlight-compound {
      background-color: #f97316;
      color: white;
      padding: 2px 4px;
      border-radius: 2px;
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 8px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Contenteditable placeholder */
    #editableContent:empty:before {
      content: attr(placeholder);
      color: #9ca3af;
      font-style: italic;
    }

    #editableContent:focus:before {
      content: none;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">üîç FuzzyFindJS Text Search</h1>
      <p class="text-gray-600">Search within text and see highlighted matches with advanced fuzzy search</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Main Content Area (Left - 2 columns) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Search Input -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <label for="searchInput" class="block text-sm font-semibold text-gray-700 mb-2">
            Search Query
          </label>
          <input type="text" id="searchInput" placeholder="Type to search... or try FQL: fql(library AND search)"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition" />

          <!-- FQL Examples -->
          <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs font-semibold text-blue-900">üîç FQL Examples (Click to try)</span>
              <span class="text-xs text-blue-600">FQL Enabled ‚úì</span>
            </div>
            <div class="flex flex-wrap gap-2">
              <button onclick="tryExample('fql(library AND search)')"
                class="text-xs px-2 py-1 bg-white border border-blue-300 rounded hover:bg-blue-100 transition">
                library AND search
              </button>
              <button onclick="tryExample('fql(fuzzy OR phonetic)')"
                class="text-xs px-2 py-1 bg-white border border-blue-300 rounded hover:bg-blue-100 transition">
                fuzzy OR phonetic
              </button>
              <button onclick="tryExample('fql(EXACT:TypeScript)')"
                class="text-xs px-2 py-1 bg-white border border-blue-300 rounded hover:bg-blue-100 transition">
                EXACT:TypeScript
              </button>
              <button onclick="tryExample('fql(FUZZY:librery)')"
                class="text-xs px-2 py-1 bg-white border border-blue-300 rounded hover:bg-blue-100 transition">
                FUZZY:librery (typo)
              </button>
              <button onclick="tryExample('fql((language OR multi) AND support)')"
                class="text-xs px-2 py-1 bg-white border border-blue-300 rounded hover:bg-blue-100 transition">
                (language OR multi) AND support
              </button>
              <button onclick="tryExample('fql(performance SCORE>0.9)')"
                class="text-xs px-2 py-1 bg-white border border-blue-300 rounded hover:bg-blue-100 transition">
                performance SCORE>0.9
              </button>
            </div>
          </div>
        </div>

        <!-- Text Content with Live Highlighting -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-semibold text-gray-900">Text Content & Search Results</h2>
              <p class="text-xs text-gray-500 mt-1">Edit text directly - highlights update in real-time ‚Ä¢ Punctuation is
                ignored for matching</p>
            </div>
            <div class="flex items-center space-x-4">
              <div id="matchCount" class="text-sm text-gray-600">
                No matches
              </div>
              <button id="resetText" class="text-sm text-gray-600 hover:text-gray-900 font-medium">
                Reset to Default
              </button>
            </div>
          </div>
          <div id="editableContent" contenteditable="true"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition text-sm leading-relaxed custom-scrollbar"
            style="min-height: 400px; max-height: 600px; overflow-y: auto;"
            placeholder="Enter or paste your text content here..."></div>
          <div class="mt-2 text-xs text-gray-500">
            <span id="wordCount">0 words</span> ‚Ä¢ Changes are saved automatically
          </div>
        </div>

        <!-- Match Details -->
        <div id="matchDetails" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hidden">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">Match Details</h3>
          <div id="matchList" class="space-y-2"></div>
        </div>
      </div>

      <!-- Settings Sidebar (Right - 1 column) -->
      <div class="space-y-6">
        <!-- Performance Mode -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Performance Mode</h3>
          <div class="space-y-3">
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="performance" value="fast" class="w-4 h-4 text-blue-600">
              <div class="ml-3">
                <div class="text-sm font-medium text-gray-900">Fast</div>
                <div class="text-xs text-gray-500">Quick results</div>
              </div>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="performance" value="balanced" checked class="w-4 h-4 text-blue-600">
              <div class="ml-3">
                <div class="text-sm font-medium text-gray-900">Balanced</div>
                <div class="text-xs text-gray-500">Good mix (default)</div>
              </div>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" name="performance" value="comprehensive" class="w-4 h-4 text-blue-600">
              <div class="ml-3">
                <div class="text-sm font-medium text-gray-900">Comprehensive</div>
                <div class="text-xs text-gray-500">Best accuracy</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Match Type Highlights -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Match Type Colors</h3>
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="highlight-exact text-xs font-medium">Exact</span>
              <span class="text-xs text-gray-500">100% match</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="highlight-fuzzy text-xs font-medium">Fuzzy</span>
              <span class="text-xs text-gray-500">Typo-tolerant</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="highlight-phonetic text-xs font-medium">Phonetic</span>
              <span class="text-xs text-gray-500">Sounds similar</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="highlight-synonym text-xs font-medium">Synonym</span>
              <span class="text-xs text-gray-500">Similar meaning</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="highlight-prefix text-xs font-medium">Prefix</span>
              <span class="text-xs text-gray-500">Starts with</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="highlight-compound text-xs font-medium">Compound</span>
              <span class="text-xs text-gray-500">Word parts</span>
            </div>
          </div>
        </div>

        <!-- Features -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Features</h3>
          <div class="space-y-3">
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-phonetic" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Phonetic Matching</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-compound" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Compound Words</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-synonyms" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Synonyms</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-keyboard-neighbors" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Keyboard Neighbors</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-partial-words" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Partial Words</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-missing-letters" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Missing Letters</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-extra-letters" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Extra Letters</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="feature-transpositions" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Transpositions</span>
            </label>
          </div>
        </div>

        <!-- Advanced Settings -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Advanced Settings</h3>
          <div class="space-y-4">
            <div>
              <label class="text-xs text-gray-600 mb-2 block">
                Max Results: <span id="maxResultsValue" class="font-semibold">10</span>
              </label>
              <input type="range" id="maxResults" min="1" max="50" value="10"
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
            </div>
            <div>
              <label class="text-xs text-gray-600 mb-2 block">
                Fuzzy Threshold: <span id="fuzzyThresholdValue" class="font-semibold">0.8</span>
              </label>
              <input type="range" id="fuzzyThreshold" min="0" max="1" step="0.1" value="0.8"
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
            </div>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="enableFQL" checked class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Enable FQL</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" id="showDebug" class="w-4 h-4 text-blue-600 rounded">
              <span class="ml-3 text-sm text-gray-700">Show Debug Info</span>
            </label>
          </div>
        </div>

        <!-- Cache Stats -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-3">Cache Statistics</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Hits:</span>
              <span id="cacheHits" class="font-medium text-gray-900">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Misses:</span>
              <span id="cacheMisses" class="font-medium text-gray-900">0</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Hit Rate:</span>
              <span id="cacheHitRate" class="font-medium text-gray-900">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Default text content
    const DEFAULT_TEXT = `FuzzyFindJS is a powerful fuzzy search library with multi-language support. It features phonetic matching, compound word splitting, and intelligent synonym support. The library is optimized for performance with three different modes: fast, balanced, and comprehensive. It includes an inverted index for large datasets and search result caching for lightning-fast autocomplete.

The library supports multiple languages including German, English, Spanish, and French. Each language has specialized processors that handle language-specific features like German compound words (Krankenhaus = Kranken + Haus) and umlaut normalization (√§ ‚Üí ae, √∂ ‚Üí oe, √º ‚Üí ue).

Advanced features include phrase search with quotes, FQL (Fuzzy Query Language) for complex queries, automatic language detection, and customizable match scoring. The library is fully typed with TypeScript and has zero dependencies.`;

    // State
    let fuzzyIndex = null;
    let currentConfig = {
      performance: 'balanced',
      features: ['phonetic', 'compound', 'synonyms', 'keyboard-neighbors', 'partial-words', 'missing-letters', 'extra-letters', 'transpositions'],
      maxResults: 10,
      fuzzyThreshold: 0.8,
      enableFQL: true,  // FQL enabled by default
      showDebug: false
    };

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const editableContent = document.getElementById('editableContent');
    const matchCount = document.getElementById('matchCount');
    const matchDetails = document.getElementById('matchDetails');
    const matchList = document.getElementById('matchList');
    const wordCount = document.getElementById('wordCount');
    const resetText = document.getElementById('resetText');

    // Load from localStorage or use default
    function loadFromStorage() {
      const savedSearch = localStorage.getItem('fuzzySearch');
      const savedText = localStorage.getItem('fuzzyText');
      const savedConfig = localStorage.getItem('fuzzyConfig');

      if (savedSearch) searchInput.value = savedSearch;
      if (savedText) editableContent.textContent = savedText;
      else editableContent.textContent = DEFAULT_TEXT;

      if (savedConfig) {
        currentConfig = { ...currentConfig, ...JSON.parse(savedConfig) };
        applyConfigToUI();
      }

      updateWordCount();
      rebuildIndex();
    }

    // Save to localStorage
    function saveToStorage() {
      localStorage.setItem('fuzzySearch', searchInput.value);
      localStorage.setItem('fuzzyText', getPlainText());
      localStorage.setItem('fuzzyConfig', JSON.stringify(currentConfig));
    }

    // Get plain text from contenteditable (strip HTML)
    function getPlainText() {
      return editableContent.textContent || editableContent.innerText || '';
    }

    // Apply config to UI
    function applyConfigToUI() {
      // Performance mode
      document.querySelector(`input[name="performance"][value="${currentConfig.performance}"]`).checked = true;

      // Features
      currentConfig.features.forEach(feature => {
        const checkbox = document.getElementById(`feature-${feature}`);
        if (checkbox) checkbox.checked = true;
      });

      // Advanced settings
      document.getElementById('maxResults').value = currentConfig.maxResults;
      document.getElementById('maxResultsValue').textContent = currentConfig.maxResults;
      document.getElementById('fuzzyThreshold').value = currentConfig.fuzzyThreshold;
      document.getElementById('fuzzyThresholdValue').textContent = currentConfig.fuzzyThreshold;
      document.getElementById('enableFQL').checked = currentConfig.enableFQL;
      document.getElementById('showDebug').checked = currentConfig.showDebug;
    }

    // Update word count
    function updateWordCount() {
      const text = getPlainText().trim();
      const words = text ? text.split(/\s+/).length : 0;
      wordCount.textContent = `${words} words`;
    }

    // Rebuild fuzzy index
    function rebuildIndex() {
      const text = getPlainText().trim();
      if (!text) {
        fuzzyIndex = null;
        return;
      }

      // Split text into words and clean them (remove punctuation)
      const rawWords = text.split(/\s+/);
      const cleanWords = rawWords.map(word => word.replace(/[.,!?;:()"\[\]{}]/g, ''));

      // Build index with cleaned words
      fuzzyIndex = FuzzyFindJS.buildFuzzyIndex(cleanWords, {
        config: {
          performance: currentConfig.performance,
          features: currentConfig.features,
          maxResults: currentConfig.maxResults,
          fuzzyThreshold: currentConfig.fuzzyThreshold
        }
      });

      // Trigger search if there's a query
      if (searchInput.value.trim()) {
        performSearch();
      }
    }

    // Perform search
    function performSearch() {
      const query = searchInput.value.trim();

      if (!query || !fuzzyIndex) {
        // Clear highlights - show plain text
        const plainText = getPlainText();
        editableContent.textContent = plainText;
        matchCount.textContent = 'No matches';
        matchDetails.classList.add('hidden');
        return;
      }

      // Search - use higher limit for highlighting all matches
      const results = FuzzyFindJS.getSuggestions(
        fuzzyIndex,
        query,
        100,  // Get more results for highlighting
        {
          fuzzyThreshold: currentConfig.fuzzyThreshold,
          enableFQL: currentConfig.enableFQL,
          includeHighlights: true
        }
      );

      // Update match count
      matchCount.textContent = `Found ${results.length} match${results.length !== 1 ? 'es' : ''}`;

      // Highlight text in the editable content
      highlightText(results);

      // Show match details if debug enabled
      if (currentConfig.showDebug) {
        showMatchDetails(results);
      } else {
        matchDetails.classList.add('hidden');
      }

      // Update cache stats
      updateCacheStats();
    }

    // Highlight text with matches in contenteditable
    function highlightText(results) {
      // Save cursor position
      const selection = window.getSelection();
      const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
      const cursorOffset = range ? range.startOffset : 0;
      const cursorNode = range ? range.startContainer : null;

      const text = getPlainText();
      const words = text.split(/\s+/);

      // Debug: Always log for now
      console.log('=== HIGHLIGHT DEBUG ===');
      console.log('Query:', searchInput.value);
      console.log('Results count:', results.length);
      console.log('First result FULL:', results[0]);
      console.log('Result displays:', results.map(r => r.display));
      console.log('Result baseWords:', results.map(r => r.baseWord));

      // Create a map of clean word -> match type
      const matchMap = new Map();
      results.forEach(result => {
        // Get match type - handle both _debug_matchType and regular matchType
        const matchType = result._debug_matchType || result.matchType || 'exact';

        // Try multiple properties: display, baseWord, word
        const displayWord = result.display || result.baseWord || result.word || '';
        const cleanDisplay = displayWord.toLowerCase().replace(/[.,!?;:()"\[\]{}]/g, '');

        console.log(`Result: display="${result.display}", baseWord="${result.baseWord}", clean="${cleanDisplay}", type=${matchType}`);

        if (cleanDisplay) {  // Only add if there's content
          matchMap.set(cleanDisplay, matchType);
        }
      });

      console.log('Match map size:', matchMap.size);
      console.log('Match map entries:', Array.from(matchMap.entries()));

      // Build highlighted HTML
      const highlightedWords = words.map(word => {
        // Clean the word for matching (remove punctuation)
        const cleanWord = word.toLowerCase().replace(/[.,!?;:()"\[\]{}]/g, '');
        const matchType = matchMap.get(cleanWord);

        if (matchType && cleanWord) {  // Only highlight if there's actual content after cleaning
          return `<span class="highlight-${matchType}">${word}</span>`;
        }
        return word;
      });

      editableContent.innerHTML = highlightedWords.join(' ');

      // Try to restore cursor position (best effort)
      try {
        if (cursorNode && editableContent.contains(cursorNode)) {
          const newRange = document.createRange();
          newRange.setStart(cursorNode, Math.min(cursorOffset, cursorNode.length));
          newRange.collapse(true);
          selection.removeAllRanges();
          selection.addRange(newRange);
        }
      } catch (e) {
        // Cursor restoration failed, that's okay
      }
    }

    // Show match details
    function showMatchDetails(results) {
      matchDetails.classList.remove('hidden');

      matchList.innerHTML = results.map((result, i) => `
        <div class="flex items-center justify-between text-sm p-2 bg-gray-50 rounded">
          <div class="flex items-center space-x-2">
            <span class="highlight-${result._debug_matchType || 'exact'} text-xs">${result.display}</span>
            <span class="text-gray-500 text-xs">${Math.round(result.score * 100)}%</span>
          </div>
          <span class="text-xs text-gray-400">${result._debug_matchType || 'exact'}</span>
        </div>
      `).join('');
    }

    // Update cache stats
    function updateCacheStats() {
      // This would need to be exposed by the library
      // For now, just placeholder
      document.getElementById('cacheHits').textContent = '0';
      document.getElementById('cacheMisses').textContent = '0';
      document.getElementById('cacheHitRate').textContent = '0%';
    }

    // Event Listeners
    searchInput.addEventListener('input', () => {
      performSearch();
      saveToStorage();
    });

    // Handle contenteditable input with debouncing
    let inputTimeout;
    editableContent.addEventListener('input', () => {
      updateWordCount();

      // Debounce rebuild and search (wait 500ms after user stops typing)
      clearTimeout(inputTimeout);
      inputTimeout = setTimeout(() => {
        rebuildIndex();
        saveToStorage();
      }, 500);
    });

    // Handle paste - strip formatting
    editableContent.addEventListener('paste', (e) => {
      e.preventDefault();
      const text = e.clipboardData.getData('text/plain');
      document.execCommand('insertText', false, text);
    });

    resetText.addEventListener('click', () => {
      editableContent.textContent = DEFAULT_TEXT;
      updateWordCount();
      rebuildIndex();
      saveToStorage();
    });

    // Performance mode
    document.querySelectorAll('input[name="performance"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentConfig.performance = e.target.value;
        rebuildIndex();
        saveToStorage();
      });
    });

    // Features
    document.querySelectorAll('[id^="feature-"]').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const feature = checkbox.id.replace('feature-', '');
        if (checkbox.checked) {
          if (!currentConfig.features.includes(feature)) {
            currentConfig.features.push(feature);
          }
        } else {
          currentConfig.features = currentConfig.features.filter(f => f !== feature);
        }
        rebuildIndex();
        saveToStorage();
      });
    });

    // Advanced settings
    document.getElementById('maxResults').addEventListener('input', (e) => {
      currentConfig.maxResults = parseInt(e.target.value);
      document.getElementById('maxResultsValue').textContent = currentConfig.maxResults;
      performSearch();
      saveToStorage();
    });

    document.getElementById('fuzzyThreshold').addEventListener('input', (e) => {
      currentConfig.fuzzyThreshold = parseFloat(e.target.value);
      document.getElementById('fuzzyThresholdValue').textContent = currentConfig.fuzzyThreshold;
      performSearch();
      saveToStorage();
    });

    document.getElementById('enableFQL').addEventListener('change', (e) => {
      currentConfig.enableFQL = e.target.checked;
      performSearch();
      saveToStorage();
    });

    document.getElementById('showDebug').addEventListener('change', (e) => {
      currentConfig.showDebug = e.target.checked;
      performSearch();
      saveToStorage();
    });

    // Try FQL example
    function tryExample(query) {
      searchInput.value = query;
      performSearch();
      saveToStorage();

      // Scroll to results
      editableContent.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Initialize
    loadFromStorage();
  </script>
</body>

</html>